{% load wagtailadmin_tags i18n %}

<div class="w-flex w-pr-8 w-mr-5 w-border-r w-border-border-furniture">
    {% for session in sessions|slice:":4" %}
        {% if session.revision_id %}
            {% fragment as avatar %}
                <div class="w-relative">
                    {% avatar user=session.user classname="w-mx-[1px] w-w-7 w-h-7 w-border-2 w-border-critical-200 w-ping w-ping--critical" %}
                    {% icon name="warning" classname="w-text-critical-200 w-w-4 w-h-4 w-absolute -w-bottom-2 w-left-2 w-z-10 w-stroke-surface-header w-shadow-white group-hover:w-hidden" %}
                </div>
            {% endfragment %}

            {% blocktranslate trimmed with user_name=session.user|user_display_name|default:_("system") asvar saved_new_version_message %}
                {{ user_name }} saved a new version
            {% endblocktranslate %}

            {% dropdown theme="popup" classname="w-group" toggle_label=avatar toggle_classname="w-p-0" %}
                <div class="w-flex w-flex-col w-items-center w-justify-center w-gap-1 w-p-1">
                    <div class="w-label-2 w-flex w-items-center w-gap-1.5">
                        {% icon name="warning" classname="w-text-critical-200 w-w-5 w-h-5" %}
                        {{ saved_new_version_message|capfirst }}
                    </div>

                    {% fragment as refresh_button_content %}
                        {% icon name="rotate" %}
                        {% trans "Refresh" %}
                    {% endfragment %}
                    {% dialog_toggle classname="button button-small button-secondary chooser__choose-button" text=refresh_button_content dialog_id="w-unsaved-changes-dialog" %}
                </div>
            {% enddropdown %}
        {% elif session.is_editing %}
            {% fragment as avatar %}
                {% avatar user=session.user classname="w-mx-[1px] w-w-7 w-h-7 w-border-2 w-border-warning-100" %}
            {% endfragment %}

            {% blocktranslate trimmed with user_name=session.user|user_display_name|default:_("system") asvar has_unsaved_changes_message %}
                {{ user_name }} has unsaved changes
            {% endblocktranslate %}

            {% dropdown theme="popup" toggle_label=avatar toggle_classname="w-p-0" %}
                <div class="w-label-2 w-flex w-items-center w-gap-1.5 w-p-1">
                    {% icon name="warning" classname="w-text-warning-100 w-w-5 w-h-5" %}
                    {{ has_unsaved_changes_message|capfirst }}
                </div>
            {% enddropdown %}
        {% else %}
            {% fragment as avatar %}
                {% avatar user=session.user classname="w-mx-[1px] w-w-7 w-h-7 w-border-2 w-border-surface-field hover:w-border-positive-100" %}
            {% endfragment %}

            <div>
                <button class="w-p-0 w-bg-transparent" type="button" data-controller="w-tooltip">
                    {{ avatar }}
                    <div class="w-flex w-flex-col w-items-center w-justify-center" data-w-tooltip-target="content" hidden>
                        <span class="w-font-semibold">{{ session.user|user_display_name|default:_("system")|capfirst }}</span>
                        <span>{% trans "Currently viewing" %}</span>
                    </div>
                </button>
            </div>
        {% endif %}
    {% endfor %}
    {% if sessions|length > 4 %}
        {% fragment as more_sessions_toggle %}
            <div class="w-flex w-items-center w-justify-center w-bg-surface-page w-rounded-full w-w-7 w-h-7 w-border-2 w-border-border-furniture hover:w-border-positive-100 w-font-bold w-text-11">
                +{{ sessions|length|add:"-4" }}
            </div>
        {% endfragment %}

        {% dropdown theme="drilldown" toggle_label=more_sessions_toggle toggle_classname="w-p-0 w-mx-[1px]" %}
            <div class="w-flex w-flex-col w-gap-4 w-p-2">
                {% for session in sessions|slice:"4:" %}
                    <div class="w-flex w-items-center">
                        {% avatar user=session.user size="small" %}
                        <span class="w-text-14">{{ session.user|user_display_name|default:_("system")|capfirst }}</span>
                    </div>
                {% endfor %}
            </div>
        {% enddropdown %}
    {% endif %}
</div>

{% if sessions.0.revision_id %}
    <template data-controller="w-teleport" data-w-teleport-target-value="#title-text-w-overwrite-changes-dialog" data-w-teleport-reset-value="true">
        {% blocktranslate trimmed with user_name=sessions.0.user|user_display_name|default:_("system") model_name=_("page") asvar someone_has_saved_message %}
            {{ user_name }} has saved a newer version of this {{ model_name }}
        {% endblocktranslate %}
        {{ someone_has_saved_message|capfirst }}
    </template>

    <template data-controller="w-teleport" data-w-teleport-target-value="#subtitle-w-overwrite-changes-dialog" data-w-teleport-reset-value="true">
        {% blocktranslate trimmed with user_name=sessions.0.user|user_display_name|default:_("system") asvar overwrite_message %}
            Proceeding will overwrite the changes made by {{ user_name }}. Refreshing the page will lose any of your unsaved changes.
        {% endblocktranslate %}
        {{ overwrite_message|capfirst }}
    </template>
{% endif %}
